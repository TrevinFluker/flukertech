<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', sans-serif;
        }

        body {
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: white;
            padding: 20px;
            position: relative;
        }

        .game-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 0px;
            text-align: center;
        }

        .score {
            font-size: 24px;
            margin-bottom: 0px;
            font-weight: 700;
            margin-top: 10px;
            
        }

        .circle-container {
            width: 270px;
            height: 270px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 0px;
            position: relative;
            margin-top: 5px;
        }

        .circle {
            width: 125px;
            height: 125px;
            border-radius: 50%;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .red { background-color: #ff4444; }
        .blue { background-color: #4444ff; }
        .green { background-color: #44ff44; }
        .yellow { background-color: #ffff44; }

        .dim {
            opacity: 0.3;
        }

        .bright {
            opacity: 1;
        }

        .timer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .timer {
            font-size: 60px;
            font-weight: 800;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(0.8); }
        }

        .pulse {
            animation: pulse 1s infinite;
            display: inline-block;
        }

        .help-text {
            font-size: 16px;
            color: #888;
            text-align: center;
            margin-top: 2px;
            font-weight: 600;
            line-height: 1.2;
        }

        .example {
            color: #999;
            margin-top: 0px;
        }

        .status {
            font-size: 24px;
            margin-bottom: 0px;
            text-align: center;
            min-height: 30px;
            font-weight: 700;
            margin-top: 5px;
            height: 60px; /* Fixed height for two lines */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* Wave animation for status */
        @keyframes waveAnimation {
            0% { transform: translateY(0px); }
            25% { transform: translateY(-5px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(5px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes gentleWaveAnimation {
            0% { transform: translateY(0px); }
            25% { transform: translateY(-2px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(2px); }
            100% { transform: translateY(0px); }
        }
        
        .wave-text {
            animation: waveAnimation 2s ease-in-out infinite;
            display: inline-block;
            width: 100%;
            line-height: 1.2;
        }
        
        /* Letter-by-letter wave animation */
        .wave-text span {
            display: inline-block;
            animation: gentleWaveAnimation 1.5s ease-in-out infinite;
        }
        
        .wave-text .space {
            display: inline-block;
            width: 0.3em;
        }
        
        /* Apply different delays to create wave effect */
        .wave-text span:nth-child(1) { animation-delay: 0.0s; }
        .wave-text span:nth-child(2) { animation-delay: 0.1s; }
        .wave-text span:nth-child(3) { animation-delay: 0.2s; }
        .wave-text span:nth-child(4) { animation-delay: 0.3s; }
        .wave-text span:nth-child(5) { animation-delay: 0.4s; }
        .wave-text span:nth-child(6) { animation-delay: 0.5s; }
        .wave-text span:nth-child(7) { animation-delay: 0.6s; }
        .wave-text span:nth-child(8) { animation-delay: 0.7s; }
        .wave-text span:nth-child(9) { animation-delay: 0.8s; }
        .wave-text span:nth-child(10) { animation-delay: 0.9s; }
        .wave-text span:nth-child(11) { animation-delay: 1.0s; }
        .wave-text span:nth-child(12) { animation-delay: 1.1s; }
        .wave-text span:nth-child(13) { animation-delay: 1.2s; }
        .wave-text span:nth-child(14) { animation-delay: 1.3s; }
        .wave-text span:nth-child(15) { animation-delay: 1.4s; }
        .wave-text span:nth-child(16) { animation-delay: 1.5s; }

        .pattern {
            font-size: 28px;
            font-weight: 700;
            margin-top: 5px;
            letter-spacing: 2px;
        }

        /* TikTok Comments Styles */
        .comments-container {
            width: 100%;
            max-width: 340px; 
            max-height: 320px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .comments-container::-webkit-scrollbar {
            display: none;
        }

        .comment-item {
            display: flex;
            align-items: center;
            background: rgba(60, 60, 60, 0.5);
            border-radius: 10px;
            padding: 2px 12px;
            gap: 5px;
            animation: fadeIn 0.3s ease-in-out;
            height: 35px;
            width: 100%; /* Ensure full width */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .profile-pic {
            width: 30px;
            height: 30px;
            border-radius: 0px;
            object-fit: cover;
        }

        .comment-content {
            flex: 1;
        }

        .username {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            line-height: 30px;
        }

        .result-icon {
            font-size: 18px;
            margin-left: auto;
        }

        .correct {
            background: rgba(50, 150, 50, 0.3);
        }

        /* Side Panel Styles */
        .sidepanel {
            position: fixed;
            right: 0;
            top: 0;
            width: 280px;
            height: 100%;
            background-color: #222;
            border-left: 1px solid #333;
            padding: 20px;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
            overflow-y: auto;
            transform: translateX(280px);
            transition: transform 0.3s ease;
        }

        .sidepanel.open {
            transform: translateX(0);
        }

        .sidepanel-title {
            font-size: 22px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
            font-family: 'Inter', sans-serif;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #ccc;
            margin-bottom: 8px;
            font-family: 'Inter', sans-serif;
        }

        .control-input {
            width: 100%;
            padding: 10px 12px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        .control-input:focus {
            outline: none;
            border-color: #666;
        }

        .toggle-sidepanel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            font-size: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .username-modal {
            background-color: #222;
            border-radius: 8px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            font-family: 'Inter', sans-serif;
        }

        .winner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding-bottom: 15%; /* Move overlay up by adding padding to the bottom */
        }

        .winner-container {
            width: 270px;
            background-color: #222;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .winner-title {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 15px;
            color: #fff;
        }

        .winners-list {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            padding-top: 50px; /* Add space at the top of the list */
        }

        .winner-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center; /* Center items */
        }

        .winner-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4a8fe7;
        }

        .winner-name {
            font-weight: 600;
            font-size: 16px;
            color: #fff;
            text-align: left;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .winner-button {
            background-color: #4a8fe7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .winner-button:hover {
            background-color: #3a7fd7;
        }

        .username-modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: white;
        }

        .username-modal-text {
            font-size: 14px;
            margin-bottom: 20px;
            color: #ccc;
        }

        .username-modal-button {
            background-color: #555;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .username-modal-button:hover {
            background-color: #666;
        }

        .save-button {
            background-color: #4a8fe7;
        }

        .save-button:hover {
            background-color: #3a7fd7;
        }

        @media (max-width: 800px) {
            .sidepanel {
                width: 250px;
            }
        }

        /* Add accordion styles for side panel */
        .accordion {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .accordion-header {
            background-color: #333;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            user-select: none;
        }
        
        .accordion-header:hover {
            background-color: #444;
        }
        
        .accordion-content {
            background-color: #2a2a2a;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-radius: 0 0 4px 4px;
        }
        
        .accordion-content.active {
            max-height: 600px;
            padding: 10px 15px;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .accordion-content.active::-webkit-scrollbar {
            display: none;
        }
        
        .color-setting {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }
        
        .color-setting:last-child {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: none;
        }
        
        .color-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .color-controls {
            margin-top: 8px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        .control-row label {
            font-size: 12px;
            min-width: 60px;
        }
        
        .control-row input {
            flex: 1;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Start Game Button Styles */
        .start-game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translateY(-118px); /* Move button up by 118px */
            pointer-events: none; /* Allow clicks to pass through the container */
            z-index: 3000;
        }
        
        .start-game-button {
            background-color: rgba(40, 40, 40, 0.9);
            border: 3px solid white;
            border-radius: 50px;
            padding: 15px 30px;
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
            font-size: 28px;
            cursor: pointer;
            animation: pulse-button 1.5s infinite alternate;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            pointer-events: auto; /* Make button clickable */
        }
        
        .start-game-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.7);
        }
        
        @keyframes pulse-button {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        @keyframes text-strobe {
            0% { color: #ff4444; }
            20% { color: #ff9900; }
            40% { color: #ffff44; }
            60% { color: #44ff44; }
            80% { color: #4444ff; }
            100% { color: #ff44ff; }
        }
        
        .strobing-text {
            animation: text-strobe 2s linear infinite;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Best Memory Styles */
        .best-memory-container {
            width: 300px;
            margin: 15px auto;
        }
        
        .best-memory-table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(40, 40, 40, 0.7);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .best-memory-cell {
            border: 1px solid #444;
            padding: 8px 12px;
            text-align: center;
            font-weight: 600;
        }
        
        .best-memory-profile {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .best-memory-pic {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #4a8fe7;
        }
        
        .best-memory-name {
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="game-title" class="title">Memory Master</div>
        <div class="help-text">Use: r=red, b=blue, g=green, y=yellow</div>
        <div class="help-text example">Example: rgbyyrg</div>
        <div class="score">Level: <span id="level">1</span></div>
        <div class="status" id="status">Get ready...</div>
        <div class="circle-container">
            <div class="circle red dim" data-color="r"></div>
            <div class="circle blue dim" data-color="b"></div>
            <div class="circle green dim" data-color="g"></div>
            <div class="circle yellow dim" data-color="y"></div>
            <div class="timer-container">
                <div class="timer" id="timer"></div>
            </div>
        </div>
        
        <!-- Best Memory Section -->
        <div class="best-memory-container">
            <table class="best-memory-table">
                <tr>
                    <td class="best-memory-cell">Best Memory:</td>
                    <td class="best-memory-cell">
                        <div class="best-memory-profile">
                            <img id="bestMemoryPic" src="https://i.pravatar.cc/150?img=0" alt="Champion" class="best-memory-pic">
                            <span id="bestMemoryName" class="best-memory-name">None yet</span>
                        </div>
                    </td>
                    <td class="best-memory-cell">Level <span id="bestMemoryLevel">0</span></td>
                </tr>
            </table>
        </div>
        
        <!-- TikTok Comments Section -->
        <div class="comments-container" id="commentsContainer">
            <!-- Comment items will be added here dynamically -->
        </div>
    </div>

    <!-- Side Panel for Host Controls -->
    <button class="toggle-sidepanel" id="toggleSidepanel">⚙️</button>
    <div class="sidepanel" id="sidepanel">
        <div class="sidepanel-title">Host Controls</div>
        
        <div class="control-group">
            <label class="control-label" for="tiktokUsername">TikTok Username</label>
            <input type="text" class="control-input" id="tiktokUsername" placeholder="Enter your TikTok username">
        </div>
        
        <div class="control-group">
            <label class="control-label" for="profilePicUrl">Profile Picture URL</label>
            <input type="text" class="control-input" id="profilePicUrl" placeholder="Enter your profile picture URL">
            <div style="display: flex; align-items: center; margin-top: 10px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-right: 10px; background-color: #333;">
                    <img id="profilePicPreview" src="https://i.pravatar.cc/150?img=0" alt="Profile Preview" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <span style="font-size: 12px; color: #999;">Preview</span>
            </div>
        </div>
        
        <!-- TikTok Integration Section -->
        <div class="accordion">
            <div class="accordion-header" id="tiktokIntegrationHeader">
                <span>TikTok Integration</span>
                <span class="accordion-icon">▼</span>
            </div>
            <div class="accordion-content" id="tiktokIntegrationContent">
                <div class="control-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label class="control-label" style="margin-bottom: 0;">Connection Status:</label>
                        <span id="connectionStatus" style="font-weight: bold; color: #ff5555;">Disconnected</span>
                    </div>
                    <button id="connectButton" class="username-modal-button">Connect</button>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">
                        Connect to Tikfinity to receive live comments from TikTok.
                        Tikfinity desktop app desktop app should be running on your computer.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label" for="hostGuessInput">Enter Your Guess (Hosts can play along!)</label>
            <input type="text" class="control-input" id="hostGuessInput" placeholder="Type your answer..." disabled>
        </div>
        
        <div class="control-group">
            <button id="simulateCommentsBtn" class="username-modal-button" disabled>Simulate Comments (5s)</button>
        </div>
        
        <div class="control-group">
            <label class="control-label">Round Timer (seconds)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="range" id="timerRange" min="5" max="20" value="10" class="control-input" style="flex: 1;">
                <span id="timerValue" style="min-width: 25px; text-align: center;">10</span>
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">Winner Scroll Speed (seconds)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="range" id="scrollSpeedRange" min="3" max="7" value="3" class="control-input" style="flex: 1;">
                <span id="scrollSpeedValue" style="min-width: 25px; text-align: center;">3</span>
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">Game Progression</label>
            <select id="gameProgressionMode" class="control-input">
                <option value="automatic">Automatic (Default)</option>
                <option value="manual">Manual</option>
            </select>
        </div>
        
        <div class="control-group">
            <label class="control-label">Sequence Generation Mode</label>
            <select id="sequenceMode" class="control-input">
                <option value="alternating">Alternating</option>
                <option value="progressing">Progressing</option>
            </select>
            <p style="font-size: 12px; color: #999; margin-top: 5px;">
                Alternating: Each round has a completely new sequence.<br>
                Progressing: New round keeps the previous sequence and adds one color.
            </p>
        </div>

        <!-- Play Settings Accordion -->
        <div class="accordion">
            <div class="accordion-header" id="playSettingsHeader">
                <span>Play Settings</span>
                <span class="accordion-icon">▼</span>
            </div>
            <div class="accordion-content" id="playSettingsContent">
                <!-- Reset button at the top -->
                <div style="text-align: right; margin-bottom: 15px;">
                    <button id="resetColorsBtn" class="username-modal-button" style="margin: 0; background-color: #666;">
                        Reset to Default
                    </button>
                </div>
                
                <!-- Red color settings -->
                <div class="color-setting">
                    <div class="color-header">
                        <span id="redName">Red</span>
                        <span class="color-preview" style="background-color: #ff4444;"></span>
                    </div>
                    <div class="color-controls">
                        <div class="control-row">
                            <label>Key:</label>
                            <input type="text" id="redKeyInput" class="control-input" value="r" maxlength="1">
                        </div>
                        <div class="control-row">
                            <label>Name:</label>
                            <input type="text" id="redNameInput" class="control-input" value="red" maxlength="15">
                        </div>
                        <div class="control-row">
                            <label>Color:</label>
                            <input type="color" id="redColorInput" class="control-input" value="#ff4444">
                        </div>
                        <div class="control-row">
                            <label>Sound URL:</label>
                            <input type="text" id="redSoundInput" class="control-input" value="https://freesound.org/data/previews/387/387186_7255534-lq.mp3">
                        </div>
                        <div class="control-row">
                            <label>Volume:</label>
                            <div class="volume-control">
                                <input type="range" id="redVolumeInput" class="control-input" min="0" max="100" value="100">
                                <span id="redVolumeValue">100%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Blue color settings -->
                <div class="color-setting">
                    <div class="color-header">
                        <span id="blueName">Blue</span>
                        <span class="color-preview" style="background-color: #4444ff;"></span>
                    </div>
                    <div class="color-controls">
                        <div class="control-row">
                            <label>Key:</label>
                            <input type="text" id="blueKeyInput" class="control-input" value="b" maxlength="1">
                        </div>
                        <div class="control-row">
                            <label>Name:</label>
                            <input type="text" id="blueNameInput" class="control-input" value="blue" maxlength="15">
                        </div>
                        <div class="control-row">
                            <label>Color:</label>
                            <input type="color" id="blueColorInput" class="control-input" value="#4444ff">
                        </div>
                        <div class="control-row">
                            <label>Sound URL:</label>
                            <input type="text" id="blueSoundInput" class="control-input" value="https://freesound.org/data/previews/387/387187_7255534-lq.mp3">
                        </div>
                        <div class="control-row">
                            <label>Volume:</label>
                            <div class="volume-control">
                                <input type="range" id="blueVolumeInput" class="control-input" min="0" max="100" value="100">
                                <span id="blueVolumeValue">100%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Green color settings -->
                <div class="color-setting">
                    <div class="color-header">
                        <span id="greenName">Green</span>
                        <span class="color-preview" style="background-color: #44ff44;"></span>
                    </div>
                    <div class="color-controls">
                        <div class="control-row">
                            <label>Key:</label>
                            <input type="text" id="greenKeyInput" class="control-input" value="g" maxlength="1">
                        </div>
                        <div class="control-row">
                            <label>Name:</label>
                            <input type="text" id="greenNameInput" class="control-input" value="green" maxlength="15">
                        </div>
                        <div class="control-row">
                            <label>Color:</label>
                            <input type="color" id="greenColorInput" class="control-input" value="#44ff44">
                        </div>
                        <div class="control-row">
                            <label>Sound URL:</label>
                            <input type="text" id="greenSoundInput" class="control-input" value="https://freesound.org/data/previews/387/387188_7255534-lq.mp3">
                        </div>
                        <div class="control-row">
                            <label>Volume:</label>
                            <div class="volume-control">
                                <input type="range" id="greenVolumeInput" class="control-input" min="0" max="100" value="100">
                                <span id="greenVolumeValue">100%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Yellow color settings -->
                <div class="color-setting">
                    <div class="color-header">
                        <span id="yellowName">Yellow</span>
                        <span class="color-preview" style="background-color: #ffff44;"></span>
                    </div>
                    <div class="color-controls">
                        <div class="control-row">
                            <label>Key:</label>
                            <input type="text" id="yellowKeyInput" class="control-input" value="y" maxlength="1">
                        </div>
                        <div class="control-row">
                            <label>Name:</label>
                            <input type="text" id="yellowNameInput" class="control-input" value="yellow" maxlength="15">
                        </div>
                        <div class="control-row">
                            <label>Color:</label>
                            <input type="color" id="yellowColorInput" class="control-input" value="#ffff44">
                        </div>
                        <div class="control-row">
                            <label>Sound URL:</label>
                            <input type="text" id="yellowSoundInput" class="control-input" value="https://freesound.org/data/previews/522/522250_1325501-lq.mp3">
                        </div>
                        <div class="control-row">
                            <label>Volume:</label>
                            <div class="volume-control">
                                <input type="range" id="yellowVolumeInput" class="control-input" min="0" max="100" value="50">
                                <span id="yellowVolumeValue">50%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Best Memory Record</label>
            <button id="clearBestMemoryBtn" class="username-modal-button">Clear Best Memory</button>
        </div>
    </div>

    <!-- Audio elements for sounds -->
    <audio id="redSound" src="https://freesound.org/data/previews/387/387186_7255534-lq.mp3" preload="auto"></audio>
    <audio id="blueSound" src="https://freesound.org/data/previews/387/387187_7255534-lq.mp3" preload="auto"></audio>
    <audio id="greenSound" src="https://freesound.org/data/previews/387/387188_7255534-lq.mp3" preload="auto"></audio>
    <audio id="yellowSound" src="https://freesound.org/data/previews/522/522250_1325501-lq.mp3" preload="auto"></audio>

    <script>
        const circles = document.querySelectorAll('.circle');
        const timerDisplay = document.getElementById('timer');
        const hostGuessInput = document.getElementById('hostGuessInput');
        const statusDisplay = document.getElementById('status');
        const levelDisplay = document.getElementById('level');
        const commentsContainer = document.getElementById('commentsContainer');
        const toggleSidepanelBtn = document.getElementById('toggleSidepanel');
        const sidepanel = document.getElementById('sidepanel');
        const tiktokUsernameInput = document.getElementById('tiktokUsername');
        
        // Global variables for WebSocket connection
        let websocket = null;
        let connected = false;
        let sequenceMode = "alternating"; // Default mode is alternating
        let thinkingMode = true; // Whether we're in thinking mode or not

        // Function to connect to Tikfinity via WebSocket
        function connectToTikfinity() {
            if (websocket) return; // Already connected
            
            try {
                // Connect to Tikfinity running on localhost port 21213
                websocket = new WebSocket("ws://localhost:21213/");
                
                // Update UI when connection opens
                websocket.onopen = function() {
                    console.log("Connected to Tikfinity");
                    document.getElementById("connectionStatus").textContent = "Connected";
                    document.getElementById("connectionStatus").style.color = "#55ff55";
                    document.getElementById("connectButton").textContent = "Disconnect";
                    connected = true;
                };
                
                // Update UI when connection closes
                websocket.onclose = function() {
                    console.log("Disconnected from Tikfinity");
                    document.getElementById("connectionStatus").textContent = "Disconnected";
                    document.getElementById("connectionStatus").style.color = "#ff5555";
                    document.getElementById("connectButton").textContent = "Connect";
                    websocket = null;
                    connected = false;
                };
                
                // Update UI when connection has an error
                websocket.onerror = function() {
                    console.error("Connection to Tikfinity failed");
                    document.getElementById("connectionStatus").textContent = "Connection Failed";
                    document.getElementById("connectionStatus").style.color = "#ff5555";
                    document.getElementById("connectButton").textContent = "Connect";
                    websocket = null;
                    connected = false;
                };

                // Process incoming messages
                websocket.onmessage = function(event) {
                    try {
                        const parsedData = JSON.parse(event.data);
                        
                        // Skip if no message ID
                        if (!parsedData.data || parsedData.data.msgId === undefined) {
                            return;
                        }
                        
                        // Handle chat messages
                        if (parsedData.event === "chat") {
                            // Create comment data object
                            const commentData = {
                                username: parsedData.data.uniqueId || parsedData.data.nickname || "unknown",
                                comment: parsedData.data.comment || "",
                                photoUrl: parsedData.data.profilePictureUrl || "https://i.pravatar.cc/150?img=" + Math.floor(Math.random() * 10)
                            };
                            
                            // Dispatch the custom event to the window
                            const tikTokEvent = new CustomEvent('tiktokCommentEvent', {
                                detail: commentData
                            });
                            
                            window.dispatchEvent(tikTokEvent);
                            console.log('Dispatched TikTok comment:', commentData);
                        }
                    } catch (e) {
                        console.error("Error processing WebSocket message:", e);
                    }
                };
            } catch (e) {
                console.error("Error establishing WebSocket connection:", e);
                document.getElementById("connectionStatus").textContent = "Connection Failed";
                document.getElementById("connectionStatus").style.color = "#ff5555";
            }
        }

        // Function to disconnect WebSocket
        function disconnectFromTikfinity() {
            if (websocket) {
                websocket.close();
                websocket = null;
                connected = false;
                document.getElementById("connectionStatus").textContent = "Disconnected";
                document.getElementById("connectionStatus").style.color = "#ff5555";
                document.getElementById("connectButton").textContent = "Connect";
            }
        }

        // Toggle WebSocket connection
        function toggleConnection() {
            if (connected) {
                disconnectFromTikfinity();
            } else {
                connectToTikfinity();
            }
        }
        
        // Toggle sidepanel
        toggleSidepanelBtn.addEventListener('click', () => {
            sidepanel.classList.toggle('open');
        });
        
        // Save TikTok username to localStorage
        tiktokUsernameInput.addEventListener('change', () => {
            const username = tiktokUsernameInput.value.trim();
            if (username) {
                localStorage.setItem('tiktokUsername', username);
            }
        });
        
        // Save profile picture URL to localStorage
        document.getElementById('profilePicUrl').addEventListener('change', (e) => {
            const url = e.target.value.trim();
            if (url) {
                localStorage.setItem('profilePicUrl', url);
                document.getElementById('profilePicPreview').src = url;
                YOUR_PROFILE_PIC = url;
            }
        });
        
        // Preview image when URL is entered
        document.getElementById('profilePicUrl').addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url) {
                document.getElementById('profilePicPreview').src = url;
            } else {
                document.getElementById('profilePicPreview').src = "https://i.pravatar.cc/150?img=0";
            }
        });
        
        // Check if TikTok username exists
        function checkTiktokUsername() {
            const username = localStorage.getItem('tiktokUsername');
            if (!username) {
                showUsernameModal();
                return false;
            }
            tiktokUsernameInput.value = username;
            
            // Check for saved profile picture URL
            const profilePicUrl = localStorage.getItem('profilePicUrl');
            if (profilePicUrl) {
                document.getElementById('profilePicUrl').value = profilePicUrl;
                document.getElementById('profilePicPreview').src = profilePicUrl;
                YOUR_PROFILE_PIC = profilePicUrl;
            }
            
            return true;
        }
        
        // Show TikTok username modal
        function showUsernameModal() {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.classList.add('overlay');
            
            // Create modal
            const modal = document.createElement('div');
            modal.classList.add('username-modal');
            
            // Modal content
            const title = document.createElement('div');
            title.classList.add('username-modal-title');
            title.textContent = 'TikTok Username Required';
            
            const text = document.createElement('div');
            text.classList.add('username-modal-text');
            text.textContent = 'Please enter your TikTok username to continue playing Memory Master.';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.classList.add('control-input');
            input.placeholder = 'Enter your TikTok username';
            
            const profilePicInput = document.createElement('input');
            profilePicInput.type = 'text';
            profilePicInput.classList.add('control-input');
            profilePicInput.placeholder = 'Enter your profile picture URL (optional)';
            profilePicInput.style.marginTop = '10px';
            
            const button = document.createElement('button');
            button.classList.add('username-modal-button', 'save-button');
            button.textContent = 'Save & Continue';
            button.addEventListener('click', () => {
                const username = input.value.trim();
                if (username) {
                    localStorage.setItem('tiktokUsername', username);
                    tiktokUsernameInput.value = username;
                    
                    const profilePic = profilePicInput.value.trim();
                    if (profilePic) {
                        localStorage.setItem('profilePicUrl', profilePic);
                        document.getElementById('profilePicUrl').value = profilePic;
                        document.getElementById('profilePicPreview').src = profilePic;
                        YOUR_PROFILE_PIC = profilePic;
                    }
                    
                    document.body.removeChild(overlay);
                    startGame();
                } else {
                    input.style.borderColor = '#ff4444';
                }
            });
            
            // Assemble modal
            modal.appendChild(title);
            modal.appendChild(text);
            modal.appendChild(input);
            modal.appendChild(profilePicInput);
            modal.appendChild(document.createElement('br'));
            modal.appendChild(button);
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus input
            setTimeout(() => input.focus(), 100);
        }
        
        // Audio elements
        const sounds = {
            'r': document.getElementById('redSound'),
            'b': document.getElementById('blueSound'),
            'g': document.getElementById('greenSound'),
            'y': document.getElementById('yellowSound')
        };

        let sequence = [];
        let level = 1;
        let isPlaying = false;
        let canGuess = false;
        let timerInterval = null;
        let commentInterval = null;
        let simulationTimeout = null;
        let levelComments = []; // Array to store comments for the current level
        let gotCorrectAnswer = false;
        let winners = []; // Array to store winners for the current level
        let autoScrollInterval = null;
        
        // Constants for the test function
        const TEST_USERNAMES = [
            "ColorMaster42", "MemoryKing", "SiqueceQueen", "PatternPro", 
            "GameExpert", "TikTokUser123", "BrainTrainer", "MemoryWhiz",
            "GuessMaster", "ColorWizard", "MindGenius", "PlayTime", 
            "FocusedGamer", "PatternChamp", "LiveStreamFan"
        ];
        
        const PROFILE_PICS = [
            "https://i.pravatar.cc/150?img=1", 
            "https://i.pravatar.cc/150?img=2",
            "https://i.pravatar.cc/150?img=3",
            "https://i.pravatar.cc/150?img=4",
            "https://i.pravatar.cc/150?img=5",
            "https://i.pravatar.cc/150?img=6",
            "https://i.pravatar.cc/150?img=7",
            "https://i.pravatar.cc/150?img=8",
            "https://i.pravatar.cc/150?img=9",
            "https://i.pravatar.cc/150?img=10"
        ];
        
        // Your user information
        let YOUR_USERNAME = "You";
        let YOUR_PROFILE_PIC = "https://i.pravatar.cc/150?img=0"; // Generic avatar

        // Map for color codes
        const colorMap = {
            'r': 'red',
            'b': 'blue',
            'g': 'green',
            'y': 'yellow'
        };

        // Variables for game settings
        let timerDuration = 10; // Default timer duration in seconds
        let gameProgressionMode = "automatic"; // Default progression mode
        let winnerScrollDuration = 3; // Default winner scroll duration in seconds
        
        // Define default color settings for reset
        const DEFAULT_COLOR_SETTINGS = {
            'r': { key: 'r', color: '#ff4444', volume: 100, cssClass: 'red', name: 'red', soundUrl: 'https://freesound.org/data/previews/387/387186_7255534-lq.mp3' },
            'b': { key: 'b', color: '#4444ff', volume: 100, cssClass: 'blue', name: 'blue', soundUrl: 'https://freesound.org/data/previews/387/387187_7255534-lq.mp3' },
            'g': { key: 'g', color: '#44ff44', volume: 100, cssClass: 'green', name: 'green', soundUrl: 'https://freesound.org/data/previews/387/387188_7255534-lq.mp3' },
            'y': { key: 'y', color: '#ffff44', volume: 50, cssClass: 'yellow', name: 'yellow', soundUrl: 'https://freesound.org/data/previews/522/522250_1325501-lq.mp3' }
        };
        
        // Color settings
        let colorSettings = {
            'r': { key: 'r', color: '#ff4444', volume: 100, cssClass: 'red', name: 'red', soundUrl: 'https://freesound.org/data/previews/387/387186_7255534-lq.mp3' },
            'b': { key: 'b', color: '#4444ff', volume: 100, cssClass: 'blue', name: 'blue', soundUrl: 'https://freesound.org/data/previews/387/387187_7255534-lq.mp3' },
            'g': { key: 'g', color: '#44ff44', volume: 100, cssClass: 'green', name: 'green', soundUrl: 'https://freesound.org/data/previews/387/387188_7255534-lq.mp3' },
            'y': { key: 'y', color: '#ffff44', volume: 50, cssClass: 'yellow', name: 'yellow', soundUrl: 'https://freesound.org/data/previews/522/522250_1325501-lq.mp3' }
        };
        
        // Reverse mapping from key to color code
        let keyToColorMap = {};
        
        // Initialize key mapping
        function updateKeyMapping() {
            keyToColorMap = {};
            for (const colorCode in colorSettings) {
                const key = colorSettings[colorCode].key;
                keyToColorMap[key] = colorCode;
            }
            
            // Update help text to show current key mappings
            updateHelpText();
        }
        
        // Update help text based on current color settings
        function updateHelpText() {
            const helpText = document.querySelector('.help-text:not(.example)');
            const keyMappings = Object.values(colorSettings)
                .map(setting => `${setting.key}=${setting.name}`)
                .join(', ');
            helpText.textContent = `Use: ${keyMappings}`;
            
            // Update example as well
            const exampleText = document.querySelector('.help-text.example');
            const exampleKeys = Object.keys(colorSettings).map(color => colorSettings[color].key).join('');
            exampleText.textContent = `Example: ${exampleKeys.substring(0, 7)}`;
        }
        
        // Load color settings from localStorage
        function loadColorSettings() {
            const savedSettings = localStorage.getItem('colorSettings');
            if (savedSettings) {
                colorSettings = JSON.parse(savedSettings);
                
                // Update color inputs
                document.getElementById('redKeyInput').value = colorSettings['r'].key;
                document.getElementById('redNameInput').value = colorSettings['r'].name;
                document.getElementById('redColorInput').value = colorSettings['r'].color;
                document.getElementById('redSoundInput').value = colorSettings['r'].soundUrl;
                document.getElementById('redVolumeInput').value = colorSettings['r'].volume;
                document.getElementById('redVolumeValue').textContent = `${colorSettings['r'].volume}%`;
                document.getElementById('redName').textContent = colorSettings['r'].name.charAt(0).toUpperCase() + colorSettings['r'].name.slice(1);
                
                document.getElementById('blueKeyInput').value = colorSettings['b'].key;
                document.getElementById('blueNameInput').value = colorSettings['b'].name;
                document.getElementById('blueColorInput').value = colorSettings['b'].color;
                document.getElementById('blueSoundInput').value = colorSettings['b'].soundUrl;
                document.getElementById('blueVolumeInput').value = colorSettings['b'].volume;
                document.getElementById('blueVolumeValue').textContent = `${colorSettings['b'].volume}%`;
                document.getElementById('blueName').textContent = colorSettings['b'].name.charAt(0).toUpperCase() + colorSettings['b'].name.slice(1);
                
                document.getElementById('greenKeyInput').value = colorSettings['g'].key;
                document.getElementById('greenNameInput').value = colorSettings['g'].name;
                document.getElementById('greenColorInput').value = colorSettings['g'].color;
                document.getElementById('greenSoundInput').value = colorSettings['g'].soundUrl;
                document.getElementById('greenVolumeInput').value = colorSettings['g'].volume;
                document.getElementById('greenVolumeValue').textContent = `${colorSettings['g'].volume}%`;
                document.getElementById('greenName').textContent = colorSettings['g'].name.charAt(0).toUpperCase() + colorSettings['g'].name.slice(1);
                
                document.getElementById('yellowKeyInput').value = colorSettings['y'].key;
                document.getElementById('yellowNameInput').value = colorSettings['y'].name;
                document.getElementById('yellowColorInput').value = colorSettings['y'].color;
                document.getElementById('yellowSoundInput').value = colorSettings['y'].soundUrl;
                document.getElementById('yellowVolumeInput').value = colorSettings['y'].volume;
                document.getElementById('yellowVolumeValue').textContent = `${colorSettings['y'].volume}%`;
                document.getElementById('yellowName').textContent = colorSettings['y'].name.charAt(0).toUpperCase() + colorSettings['y'].name.slice(1);
                
                // Update color previews
                document.querySelectorAll('.color-preview')[0].style.backgroundColor = colorSettings['r'].color;
                document.querySelectorAll('.color-preview')[1].style.backgroundColor = colorSettings['b'].color;
                document.querySelectorAll('.color-preview')[2].style.backgroundColor = colorSettings['g'].color;
                document.querySelectorAll('.color-preview')[3].style.backgroundColor = colorSettings['y'].color;
                
                // Update circle colors
                document.querySelector(`.${colorSettings['r'].cssClass}`).style.backgroundColor = colorSettings['r'].color;
                document.querySelector(`.${colorSettings['b'].cssClass}`).style.backgroundColor = colorSettings['b'].color;
                document.querySelector(`.${colorSettings['g'].cssClass}`).style.backgroundColor = colorSettings['g'].color;
                document.querySelector(`.${colorSettings['y'].cssClass}`).style.backgroundColor = colorSettings['y'].color;
                
                // Update sound sources
                updateSoundSources();
            } else {
                // Initialize headers with default names
                document.getElementById('redName').textContent = 'Red';
                document.getElementById('blueName').textContent = 'Blue';
                document.getElementById('greenName').textContent = 'Green';
                document.getElementById('yellowName').textContent = 'Yellow';
            }
            
            updateKeyMapping();
        }
        
        // Save color settings to localStorage
        function saveColorSettings() {
            localStorage.setItem('colorSettings', JSON.stringify(colorSettings));
        }
        
        // Set up color settings event listeners
        function setupColorSettingsListeners() {
            // Reset button
            document.getElementById('resetColorsBtn').addEventListener('click', resetColorSettings);
            
            // Red settings
            document.getElementById('redKeyInput').addEventListener('input', (e) => {
                if (e.target.value) {
                    // Force single letter and lowercase
                    const key = e.target.value.toLowerCase().charAt(0);
                    e.target.value = key;
                    colorSettings['r'].key = key;
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('redNameInput').addEventListener('input', (e) => {
                const name = e.target.value.toLowerCase();
                e.target.value = name;
                if (name) {
                    colorSettings['r'].name = name;
                    document.getElementById('redName').textContent = name.charAt(0).toUpperCase() + name.slice(1);
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('redColorInput').addEventListener('change', (e) => {
                colorSettings['r'].color = e.target.value;
                document.querySelectorAll('.color-preview')[0].style.backgroundColor = e.target.value;
                document.querySelector(`.${colorSettings['r'].cssClass}`).style.backgroundColor = e.target.value;
                saveColorSettings();
            });
            
            document.getElementById('redSoundInput').addEventListener('change', (e) => {
                if (e.target.value) {
                    colorSettings['r'].soundUrl = e.target.value;
                    sounds['r'].src = e.target.value;
                    sounds['r'].load();
                    saveColorSettings();
                } else {
                    e.target.value = colorSettings['r'].soundUrl;
                }
            });
            
            document.getElementById('redVolumeInput').addEventListener('input', (e) => {
                colorSettings['r'].volume = parseInt(e.target.value);
                document.getElementById('redVolumeValue').textContent = `${e.target.value}%`;
                saveColorSettings();
            });
            
            // Blue settings
            document.getElementById('blueKeyInput').addEventListener('input', (e) => {
                if (e.target.value) {
                    // Force single letter and lowercase
                    const key = e.target.value.toLowerCase().charAt(0);
                    e.target.value = key;
                    colorSettings['b'].key = key;
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('blueNameInput').addEventListener('input', (e) => {
                const name = e.target.value.toLowerCase();
                e.target.value = name;
                if (name) {
                    colorSettings['b'].name = name;
                    document.getElementById('blueName').textContent = name.charAt(0).toUpperCase() + name.slice(1);
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('blueColorInput').addEventListener('change', (e) => {
                colorSettings['b'].color = e.target.value;
                document.querySelectorAll('.color-preview')[1].style.backgroundColor = e.target.value;
                document.querySelector(`.${colorSettings['b'].cssClass}`).style.backgroundColor = e.target.value;
                saveColorSettings();
            });
            
            document.getElementById('blueSoundInput').addEventListener('change', (e) => {
                if (e.target.value) {
                    colorSettings['b'].soundUrl = e.target.value;
                    sounds['b'].src = e.target.value;
                    sounds['b'].load();
                    saveColorSettings();
                } else {
                    e.target.value = colorSettings['b'].soundUrl;
                }
            });
            
            document.getElementById('blueVolumeInput').addEventListener('input', (e) => {
                colorSettings['b'].volume = parseInt(e.target.value);
                document.getElementById('blueVolumeValue').textContent = `${e.target.value}%`;
                saveColorSettings();
            });
            
            // Green settings
            document.getElementById('greenKeyInput').addEventListener('input', (e) => {
                if (e.target.value) {
                    // Force single letter and lowercase
                    const key = e.target.value.toLowerCase().charAt(0);
                    e.target.value = key;
                    colorSettings['g'].key = key;
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('greenNameInput').addEventListener('input', (e) => {
                const name = e.target.value.toLowerCase();
                e.target.value = name;
                if (name) {
                    colorSettings['g'].name = name;
                    document.getElementById('greenName').textContent = name.charAt(0).toUpperCase() + name.slice(1);
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('greenColorInput').addEventListener('change', (e) => {
                colorSettings['g'].color = e.target.value;
                document.querySelectorAll('.color-preview')[2].style.backgroundColor = e.target.value;
                document.querySelector(`.${colorSettings['g'].cssClass}`).style.backgroundColor = e.target.value;
                saveColorSettings();
            });
            
            document.getElementById('greenSoundInput').addEventListener('change', (e) => {
                if (e.target.value) {
                    colorSettings['g'].soundUrl = e.target.value;
                    sounds['g'].src = e.target.value;
                    sounds['g'].load();
                    saveColorSettings();
                } else {
                    e.target.value = colorSettings['g'].soundUrl;
                }
            });
            
            document.getElementById('greenVolumeInput').addEventListener('input', (e) => {
                colorSettings['g'].volume = parseInt(e.target.value);
                document.getElementById('greenVolumeValue').textContent = `${e.target.value}%`;
                saveColorSettings();
            });
            
            // Yellow settings
            document.getElementById('yellowKeyInput').addEventListener('input', (e) => {
                if (e.target.value) {
                    // Force single letter and lowercase
                    const key = e.target.value.toLowerCase().charAt(0);
                    e.target.value = key;
                    colorSettings['y'].key = key;
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('yellowNameInput').addEventListener('input', (e) => {
                const name = e.target.value.toLowerCase();
                e.target.value = name;
                if (name) {
                    colorSettings['y'].name = name;
                    document.getElementById('yellowName').textContent = name.charAt(0).toUpperCase() + name.slice(1);
                    updateKeyMapping();
                    saveColorSettings();
                }
            });
            
            document.getElementById('yellowColorInput').addEventListener('change', (e) => {
                colorSettings['y'].color = e.target.value;
                document.querySelectorAll('.color-preview')[3].style.backgroundColor = e.target.value;
                document.querySelector(`.${colorSettings['y'].cssClass}`).style.backgroundColor = e.target.value;
                saveColorSettings();
            });
            
            document.getElementById('yellowSoundInput').addEventListener('change', (e) => {
                if (e.target.value) {
                    colorSettings['y'].soundUrl = e.target.value;
                    sounds['y'].src = e.target.value;
                    sounds['y'].load();
                    saveColorSettings();
                } else {
                    e.target.value = colorSettings['y'].soundUrl;
                }
            });
            
            document.getElementById('yellowVolumeInput').addEventListener('input', (e) => {
                colorSettings['y'].volume = parseInt(e.target.value);
                document.getElementById('yellowVolumeValue').textContent = `${e.target.value}%`;
                saveColorSettings();
            });
            
            // Accordion toggle
            document.getElementById('playSettingsHeader').addEventListener('click', () => {
                const content = document.getElementById('playSettingsContent');
                content.classList.toggle('active');
                const arrow = document.querySelector('#playSettingsHeader .accordion-icon');
                arrow.textContent = content.classList.contains('active') ? '▲' : '▼';
            });
        }

        // Initialize game
        function startGame() {
            // First check if TikTok username exists
            if (!checkTiktokUsername()) {
                return; // Don't start if no username
            }
            
            // Update host username
            YOUR_USERNAME = localStorage.getItem('tiktokUsername');
            
            clearAllTimers();
            level = 1;
            sequence = [];
            levelComments = []; // Clear comments for new game
            winners = []; // Clear winners for new game
            gotCorrectAnswer = false;
            updateLevel();
            nextRound();
        }

        // Clear any active timers
        function clearAllTimers() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (commentInterval) {
                clearInterval(commentInterval);
                commentInterval = null;
            }
            timerDisplay.textContent = '';
            timerDisplay.classList.remove('pulse');
        }

        // Start next round
        function nextRound() {
            clearAllTimers();
            
            // Add a new color to the sequence based on the selected mode
            if (sequenceMode === "alternating" || sequence.length === 0) {
                // In alternating mode or first level, generate a completely new sequence
                sequence = [];
                for (let i = 0; i < level; i++) {
                    sequence.push(getRandomColor());
                }
            } else {
                // In progressing mode, keep the existing sequence and just add one new color
                sequence.push(getRandomColor());
            }
            
            levelComments = []; // Clear comments for new level
            winners = []; // Clear winners for new level
            gotCorrectAnswer = false;
            clearCommentsContainer(); // Clear displayed comments
            statusDisplay.textContent = 'Watch the pattern...';
            statusDisplay.classList.remove('wave-text');
            hostGuessInput.value = '';
            hostGuessInput.disabled = true;
            setTimeout(playSequence, 1000);
        }

        // Play the sequence
        async function playSequence() {
            isPlaying = true;
            for (let color of sequence) {
                await flashCircle(color);
                await sleep(250); // Wait between colors
            }
            isPlaying = false;
            startThinkingMode();
        }
        
        // Start thinking mode
        function startThinkingMode() {
            clearAllTimers(); // Clear any existing timer
            thinkingMode = true;
            canGuess = true;
            hostGuessInput.disabled = false;
            hostGuessInput.focus();
            
            // Enable the simulate comments button when guessing is allowed
            document.getElementById('simulateCommentsBtn').disabled = false;
            
            // Set text and add wave class
            statusDisplay.textContent = 'Think about it...';
            wrapLettersInSpans(statusDisplay, 'Think about it...');
            statusDisplay.classList.add('wave-text');
            
            // Remove any timer display
            timerDisplay.textContent = '';
            timerDisplay.classList.remove('pulse');
        }

        // Flash a circle and play its sound
        function flashCircle(color) {
            return new Promise(resolve => {
                const circle = document.querySelector(`.${colorMap[color]}`);
                circle.classList.remove('dim');
                
                // Play the corresponding sound
                playSound(color);
                
                setTimeout(() => {
                    circle.classList.add('dim');
                    setTimeout(resolve, 50);
                }, 250);
            });
        }

        // Play a sound for a specific color
        function playSound(color) {
            try {
                // Reset the sound to the beginning
                sounds[color].currentTime = 0;
                
                // Adjust volume based on settings
                sounds[color].volume = colorSettings[color].volume / 100;
                
                sounds[color].play().catch(e => console.log("Audio play error:", e));
            } catch (error) {
                console.error("Error playing sound:", error);
            }
        }

        // Start the timer after the first guess
        function startTimer() {
            if (!thinkingMode) return; // Don't restart timer if already running
            
            thinkingMode = false; // Exit thinking mode
            clearAllTimers(); // Clear any existing timer
            
            let timeLeft = timerDuration; // Use the adjustable timer duration
            
            // Set text and add wave class
            statusDisplay.textContent = 'Enter the color pattern!';
            wrapLettersInSpans(statusDisplay, 'Enter the color pattern!');
            statusDisplay.classList.add('wave-text');
            
            // Add the pulse animation class
            timerDisplay.classList.add('pulse');

            timerInterval = setInterval(() => {
                timerDisplay.textContent = timeLeft;
                
                // Reset the animation to make it pulse on each count
                timerDisplay.classList.remove('pulse');
                void timerDisplay.offsetWidth; // Trigger reflow
                timerDisplay.classList.add('pulse');
                
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timerDisplay.classList.remove('pulse');
                    stopSimulatingComments(); // Stop any ongoing simulation
                    finishRound();
                }
            }, 1000);

            timerDisplay.textContent = timeLeft;
        }
        
        // Start generating test comments for 5 seconds
        function startTestComments() {
            // Clear any existing comment simulations first
            stopSimulatingComments();
            
            // Generate a comment every 300-700ms (randomized)
            commentInterval = setInterval(() => {
                if (canGuess) {
                    generateTestComment();
                }
            }, Math.random() * 400 + 300);
            
            // Set a timeout to stop the simulation after 5 seconds
            simulationTimeout = setTimeout(() => {
                stopSimulatingComments();
            }, 5000);
        }
        
        // Stop simulating comments
        function stopSimulatingComments() {
            if (commentInterval) {
                clearInterval(commentInterval);
                commentInterval = null;
            }
            
            if (simulationTimeout) {
                clearTimeout(simulationTimeout);
                simulationTimeout = null;
            }
        }
        
        // Generate a random test comment
        function generateTestComment() {
            // Randomly decide what kind of guess to make
            const decideType = Math.random();
            let guess;
            
            if (decideType < 0.1 && sequence.length > 0) {
                // 10% chance of a completely correct guess
                guess = sequence.join('');
            } else if (decideType < 0.3 && sequence.length > 1) {
                // 20% chance of partially correct guess (first few letters)
                const partialLength = Math.floor(Math.random() * (sequence.length - 1)) + 1;
                guess = sequence.slice(0, partialLength).join('');
            } else {
                // 70% chance of random guess
                const length = Math.min(sequence.length + Math.floor(Math.random() * 3), 7);
                guess = '';
                for (let i = 0; i < length; i++) {
                    guess += ['r', 'g', 'b', 'y'][Math.floor(Math.random() * 4)];
                }
            }
            
            // Random username and profile pic
            const username = TEST_USERNAMES[Math.floor(Math.random() * TEST_USERNAMES.length)];
            const photoUrl = PROFILE_PICS[Math.floor(Math.random() * PROFILE_PICS.length)];
            
            // Process the test comment
            const commentData = {
                username: username,
                photoUrl: photoUrl,
                comment: guess
            };
            
            processComment(commentData);
        }

        // Process a TikTok comment
        function processComment(commentData) {
            // Start timer on first comment if in thinking mode
            if (thinkingMode) {
                startTimer();
            }
            
            // Create a comment object
            const isCorrect = isGuessCorrect(commentData.comment);
            
            const comment = {
                username: commentData.username,
                photoUrl: commentData.photoUrl,
                comment: commentData.comment,
                isCorrect: isCorrect
            };
            
            // Track if we got a correct answer
            if (isCorrect) {
                gotCorrectAnswer = true;
                
                // Add to winners list if not already there
                if (!winners.some(winner => winner.username === comment.username)) {
                    winners.push({
                        username: comment.username,
                        photoUrl: comment.photoUrl
                    });
                    
                    // If this is the first correct answer and the current level is higher than the best memory
                    if (winners.length === 1 && level > bestMemoryLevel) {
                        bestMemoryLevel = level;
                        bestMemoryName = comment.username;
                        bestMemoryPic = comment.photoUrl;
                        
                        // Update the display
                        document.getElementById('bestMemoryLevel').textContent = bestMemoryLevel;
                        document.getElementById('bestMemoryName').textContent = bestMemoryName;
                        document.getElementById('bestMemoryPic').src = bestMemoryPic;
                        
                        // Save to localStorage
                        saveBestMemory();
                    }
                }
            }
            
            // Add comment to the current level's comments
            levelComments.push(comment);
            
            // Render the comment
            renderComment(comment);
        }
        
        // Check if a guess is correct
        function isGuessCorrect(guess) {
            // Make sure the guess is lowercase and without spaces
            const cleanGuess = guess.toLowerCase().trim().replace(/\s+/g, '');
            
            // Convert sequence to keys for comparison
            const correctKeys = sequence.map(colorCode => colorSettings[colorCode].key).join('');
            
            return cleanGuess === correctKeys;
        }
        
        // Render a comment in the comments container
        function renderComment(comment) {
            const commentElement = document.createElement('div');
            commentElement.classList.add('comment-item');
            
            if (comment.isCorrect) {
                commentElement.classList.add('correct');
            }
            
            // Create profile picture
            const profilePic = document.createElement('img');
            profilePic.src = comment.photoUrl;
            profilePic.alt = comment.username;
            profilePic.classList.add('profile-pic');
            
            // Create username element
            const usernameElement = document.createElement('div');
            usernameElement.classList.add('username');
            usernameElement.textContent = comment.username;
            
            // Create content div (just for the username now)
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('comment-content');
            contentDiv.appendChild(usernameElement);
            
            // Create result icon
            const resultIcon = document.createElement('div');
            resultIcon.classList.add('result-icon');
            resultIcon.textContent = comment.isCorrect ? '✅' : '❌';
            
            // Assemble the comment element
            commentElement.appendChild(profilePic);
            commentElement.appendChild(contentDiv);
            commentElement.appendChild(resultIcon);
            
            // Prepend to container (add at the beginning)
            if (commentsContainer.firstChild) {
                commentsContainer.insertBefore(commentElement, commentsContainer.firstChild);
            } else {
                commentsContainer.appendChild(commentElement);
            }
        }
        
        // Clear the comments container
        function clearCommentsContainer() {
            commentsContainer.innerHTML = '';
        }
        
        // Updated finish round function to show winner overlay for successful rounds
        function finishRound() {
            canGuess = false;
            hostGuessInput.disabled = true;
            document.getElementById('simulateCommentsBtn').disabled = true;
            
            if (gotCorrectAnswer) {
                // Get correct guessers
                const winners = levelComments.filter(comment => comment.isCorrect);
                
                // Create unique winners by username (keep only the first occurrence of each username)
                const uniqueWinners = [];
                const uniqueUsernames = new Set();
                
                winners.forEach(winner => {
                    if (!uniqueUsernames.has(winner.username)) {
                        uniqueUsernames.add(winner.username);
                        uniqueWinners.push(winner);
                    }
                });
                
                // Show winner overlay
                showWinnerOverlay(uniqueWinners);
            } else {
                // Create a nice display for the correct pattern with a line break
                const patternDisplay = document.createElement('div');
                patternDisplay.classList.add('pattern');
                patternDisplay.textContent = sequence.join('');
                
                statusDisplay.textContent = 'Time\'s up! The sequence was:';
                statusDisplay.appendChild(document.createElement('br'));
                statusDisplay.appendChild(patternDisplay);
                
                setTimeout(startGame, 3000);
            }
        }
        
        // Function to show the winner overlay
        function showWinnerOverlay(winners) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.classList.add('winner-overlay');
            
            // Create container
            const container = document.createElement('div');
            container.classList.add('winner-container');
            
            // Create title
            const title = document.createElement('div');
            title.classList.add('winner-title');
            title.textContent = 'You mastered this round, here\'s the next...';
            
            // Create winners list
            const winnersList = document.createElement('div');
            winnersList.classList.add('winners-list');
            
            // Add winners
            winners.forEach(winner => {
                const winnerItem = document.createElement('div');
                winnerItem.classList.add('winner-item');
                
                const winnerPic = document.createElement('img');
                winnerPic.src = winner.photoUrl;
                winnerPic.alt = winner.username;
                winnerPic.classList.add('winner-pic');
                
                const winnerName = document.createElement('div');
                winnerName.classList.add('winner-name');
                winnerName.textContent = winner.username;
                
                winnerItem.appendChild(winnerPic);
                winnerItem.appendChild(winnerName);
                winnersList.appendChild(winnerItem);
            });
            
            // Create next level button
            const nextButton = document.createElement('button');
            nextButton.classList.add('winner-button');
            nextButton.textContent = 'Next Level';
            nextButton.addEventListener('click', () => {
                document.body.removeChild(overlay);
                level++;
                updateLevel();
                nextRound();
            });
            
            // Assemble overlay
            container.appendChild(title);
            container.appendChild(winnersList);
            container.appendChild(nextButton);
            overlay.appendChild(container);
            document.body.appendChild(overlay);
            
            // Setup auto-scrolling if needed
            if (winnersList.scrollHeight > winnersList.clientHeight) {
                // If in automatic mode, auto-advance after scrolling completes
                if (gameProgressionMode === "automatic") {
                    // Calculate scroll duration based on the user setting (in seconds)
                    const scrollDuration = winnerScrollDuration * 1000;
                    const scrollCompleteTimeout = setupAutoScroll(winnersList, scrollDuration);
                    
                    // Auto-click next button after scrolling is complete
                    setTimeout(() => {
                        if (document.body.contains(overlay)) {
                            nextButton.click();
                        }
                    }, scrollDuration + 500); // Add a small delay after scrolling
                } else {
                    // In manual mode, just scroll but don't auto-advance
                    // Use winner scroll duration here too for consistent experience
                    setupAutoScroll(winnersList, winnerScrollDuration * 1000);
                }
            } else if (gameProgressionMode === "automatic") {
                // If no scrolling needed but in automatic mode, advance after a fixed delay
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        nextButton.click();
                    }
                }, 3000);
            }
        }
        
        // Function to setup auto-scrolling for winners list
        function setupAutoScroll(element, duration) {
            if (element.scrollHeight > element.clientHeight) {
                // If content exceeds visible area, setup scrolling
                let scrollPosition = 0;
                const totalScrollDistance = element.scrollHeight - element.clientHeight;
                
                // Calculate scroll speed based on the duration if provided
                let scrollStep = 1;
                let scrollDelay = 30;
                
                if (duration) {
                    // Adjust step size to complete the scroll within the duration
                    const totalSteps = duration / scrollDelay;
                    scrollStep = totalScrollDistance / totalSteps;
                    scrollStep = Math.max(0.5, Math.min(scrollStep, 2)); // Keep step size reasonable
                }
                
                const scrollInterval = setInterval(() => {
                    scrollPosition += scrollStep;
                    element.scrollTop = scrollPosition;
                    
                    // Stop when we reach the bottom
                    if (scrollPosition >= totalScrollDistance) {
                        clearInterval(scrollInterval);
                        return true;
                    }
                }, scrollDelay);
                
                // Store interval ID to clear it later
                element.dataset.scrollInterval = scrollInterval;
                
                // Stop scrolling on hover
                element.addEventListener('mouseenter', () => {
                    clearInterval(element.dataset.scrollInterval);
                });
                
                // Resume scrolling on mouse leave
                element.addEventListener('mouseleave', () => {
                    // Only resume if we haven't reached the bottom
                    if (scrollPosition < totalScrollDistance) {
                        element.dataset.scrollInterval = setInterval(() => {
                            scrollPosition += scrollStep;
                            element.scrollTop = scrollPosition;
                            
                            // Stop when we reach the bottom
                            if (scrollPosition >= totalScrollDistance) {
                                clearInterval(element.dataset.scrollInterval);
                                return true;
                            }
                        }, scrollDelay);
                    }
                });
                
                return scrollInterval;
            }
            return null;
        }

        // Update level display
        function updateLevel() {
            levelDisplay.textContent = level;
        }

        // Utility functions
        function getRandomColor() {
            const colors = ['r', 'b', 'g', 'y'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Event listeners
        hostGuessInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && canGuess) {
                const guess = hostGuessInput.value.trim();
                if (guess) {
                    // Start timer on first input if in thinking mode
                    if (thinkingMode) {
                        startTimer();
                    }
                    
                    // Process the user's own guess
                    const commentData = {
                        username: YOUR_USERNAME,
                        photoUrl: YOUR_PROFILE_PIC,
                        comment: guess
                    };
                    
                    processComment(commentData);
                    hostGuessInput.value = '';
                }
            }
        });
        
        // TikTok comment event listener
        window.addEventListener('tiktokCommentEvent', function(event) {
            if (canGuess) {
                // Process the TikTok comment
                const commentData = {
                    username: event.detail.username,
                    photoUrl: event.detail.photoUrl,
                    comment: event.detail.comment
                };
                
                processComment(commentData);
            }
        });

        // Start the game
        window.addEventListener('load', () => {
            // First check if TikTok username exists before starting the game
            if (checkTiktokUsername()) {
                YOUR_USERNAME = localStorage.getItem('tiktokUsername');
                
                // Load color settings before starting the game
                loadColorSettings();
                setupColorSettingsListeners();
                
                // Load best memory record
                loadBestMemory();
                
                // Don't auto-start the game, wait for button click
                // startGame(); - removed
            }
            
            // Add Chrome Web Store image to the title
            const chromeStoreImg = document.createElement('img');
            chromeStoreImg.src = "https://www.runchatcapture.com/assets/imgs/chrome_web_store.png";
            chromeStoreImg.style.height = "22px";
            chromeStoreImg.style.marginLeft = "10px";
            chromeStoreImg.style.verticalAlign = "baseline";
            document.getElementById("game-title").appendChild(chromeStoreImg);
            
            // Add event listener for the simulate comments button
            document.getElementById('simulateCommentsBtn').addEventListener('click', () => {
                if (canGuess) {
                    startTestComments();
                }
            });
            
            // Setup the TikTok Integration accordion
            document.getElementById('tiktokIntegrationHeader').addEventListener('click', () => {
                const content = document.getElementById('tiktokIntegrationContent');
                content.classList.toggle('active');
                const arrow = document.querySelector('#tiktokIntegrationHeader .accordion-icon');
                arrow.textContent = content.classList.contains('active') ? '▲' : '▼';
            });
            
            // Setup WebSocket connection button
            document.getElementById('connectButton').addEventListener('click', toggleConnection);
            
            // Add event listener for the start game button
            document.getElementById('startGameButton').addEventListener('click', handleStartGameClick);
            
            // Add event listener for clear best memory button
            document.getElementById('clearBestMemoryBtn').addEventListener('click', clearBestMemory);
        });

        // Add event listener for timer range input
        document.getElementById('timerRange').addEventListener('input', (e) => {
            timerDuration = parseInt(e.target.value);
            document.getElementById('timerValue').textContent = timerDuration;
            localStorage.setItem('timerDuration', timerDuration);
        });
        
        // Load saved timer duration from localStorage
        if (localStorage.getItem('timerDuration')) {
            timerDuration = parseInt(localStorage.getItem('timerDuration'));
            document.getElementById('timerRange').value = timerDuration;
            document.getElementById('timerValue').textContent = timerDuration;
        }

        // Add event listener for game progression mode
        document.getElementById('gameProgressionMode').addEventListener('change', (e) => {
            gameProgressionMode = e.target.value;
            localStorage.setItem('gameProgressionMode', gameProgressionMode);
        });
        
        // Load saved game progression mode from localStorage
        if (localStorage.getItem('gameProgressionMode')) {
            gameProgressionMode = localStorage.getItem('gameProgressionMode');
            document.getElementById('gameProgressionMode').value = gameProgressionMode;
        }

        // Add event listener for sequence generation mode
        document.getElementById('sequenceMode').addEventListener('change', (e) => {
            sequenceMode = e.target.value;
            localStorage.setItem('sequenceMode', sequenceMode);
        });
        
        // Load saved sequence mode from localStorage
        if (localStorage.getItem('sequenceMode')) {
            sequenceMode = localStorage.getItem('sequenceMode');
            document.getElementById('sequenceMode').value = sequenceMode;
        }

        // Add event listener for scroll speed range input
        document.getElementById('scrollSpeedRange').addEventListener('input', (e) => {
            winnerScrollDuration = parseInt(e.target.value);
            document.getElementById('scrollSpeedValue').textContent = winnerScrollDuration;
            localStorage.setItem('winnerScrollDuration', winnerScrollDuration);
        });
        
        // Load saved scroll speed from localStorage
        if (localStorage.getItem('winnerScrollDuration')) {
            winnerScrollDuration = parseInt(localStorage.getItem('winnerScrollDuration'));
            document.getElementById('scrollSpeedRange').value = winnerScrollDuration;
            document.getElementById('scrollSpeedValue').textContent = winnerScrollDuration;
        }

        // Reset color settings to default
        function resetColorSettings() {
            // Reset to default values
            colorSettings = JSON.parse(JSON.stringify(DEFAULT_COLOR_SETTINGS));
            
            // Update UI
            document.getElementById('redKeyInput').value = colorSettings['r'].key;
            document.getElementById('redNameInput').value = colorSettings['r'].name;
            document.getElementById('redColorInput').value = colorSettings['r'].color;
            document.getElementById('redSoundInput').value = colorSettings['r'].soundUrl;
            document.getElementById('redVolumeInput').value = colorSettings['r'].volume;
            document.getElementById('redVolumeValue').textContent = `${colorSettings['r'].volume}%`;
            document.getElementById('redName').textContent = 'Red';
            
            document.getElementById('blueKeyInput').value = colorSettings['b'].key;
            document.getElementById('blueNameInput').value = colorSettings['b'].name;
            document.getElementById('blueColorInput').value = colorSettings['b'].color;
            document.getElementById('blueSoundInput').value = colorSettings['b'].soundUrl;
            document.getElementById('blueVolumeInput').value = colorSettings['b'].volume;
            document.getElementById('blueVolumeValue').textContent = `${colorSettings['b'].volume}%`;
            document.getElementById('blueName').textContent = 'Blue';
            
            document.getElementById('greenKeyInput').value = colorSettings['g'].key;
            document.getElementById('greenNameInput').value = colorSettings['g'].name;
            document.getElementById('greenColorInput').value = colorSettings['g'].color;
            document.getElementById('greenSoundInput').value = colorSettings['g'].soundUrl;
            document.getElementById('greenVolumeInput').value = colorSettings['g'].volume;
            document.getElementById('greenVolumeValue').textContent = `${colorSettings['g'].volume}%`;
            document.getElementById('greenName').textContent = 'Green';
            
            document.getElementById('yellowKeyInput').value = colorSettings['y'].key;
            document.getElementById('yellowNameInput').value = colorSettings['y'].name;
            document.getElementById('yellowColorInput').value = colorSettings['y'].color;
            document.getElementById('yellowSoundInput').value = colorSettings['y'].soundUrl;
            document.getElementById('yellowVolumeInput').value = colorSettings['y'].volume;
            document.getElementById('yellowVolumeValue').textContent = `${colorSettings['y'].volume}%`;
            document.getElementById('yellowName').textContent = 'Yellow';
            
            // Update color previews
            document.querySelectorAll('.color-preview')[0].style.backgroundColor = colorSettings['r'].color;
            document.querySelectorAll('.color-preview')[1].style.backgroundColor = colorSettings['b'].color;
            document.querySelectorAll('.color-preview')[2].style.backgroundColor = colorSettings['g'].color;
            document.querySelectorAll('.color-preview')[3].style.backgroundColor = colorSettings['y'].color;
            
            // Update circle colors
            document.querySelector(`.${colorSettings['r'].cssClass}`).style.backgroundColor = colorSettings['r'].color;
            document.querySelector(`.${colorSettings['b'].cssClass}`).style.backgroundColor = colorSettings['b'].color;
            document.querySelector(`.${colorSettings['g'].cssClass}`).style.backgroundColor = colorSettings['g'].color;
            document.querySelector(`.${colorSettings['y'].cssClass}`).style.backgroundColor = colorSettings['y'].color;
            
            // Update sound sources
            updateSoundSources();
            
            // Update help text
            updateKeyMapping();
            
            // Save to localStorage
            saveColorSettings();
        }
        
        // Update the audio element sources based on current settings
        function updateSoundSources() {
            sounds['r'].src = colorSettings['r'].soundUrl;
            sounds['b'].src = colorSettings['b'].soundUrl;
            sounds['g'].src = colorSettings['g'].soundUrl;
            sounds['y'].src = colorSettings['y'].soundUrl;
            
            // Preload the sounds
            sounds['r'].load();
            sounds['b'].load();
            sounds['g'].load();
            sounds['y'].load();
        }

        // Function to wrap each letter in a span for the wave effect, preserving spaces
        function wrapLettersInSpans(element, text) {
            element.innerHTML = '';
            
            // Add a container to hold all content and center it vertically
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.justifyContent = 'center';
            container.style.height = '100%';
            
            const textContainer = document.createElement('div');
            textContainer.style.lineHeight = '1.2';
            
            for (let i = 0; i < text.length; i++) {
                if (text[i] === ' ') {
                    // Add a space element
                    const space = document.createElement('span');
                    space.className = 'space';
                    space.innerHTML = '&nbsp;';
                    textContainer.appendChild(space);
                } else {
                    // Add a letter in a span
                    const span = document.createElement('span');
                    span.textContent = text[i];
                    textContainer.appendChild(span);
                }
            }
            
            container.appendChild(textContainer);
            element.appendChild(container);
        }

        // Function to handle the start game button click
        function handleStartGameClick() {
            // Hide the start game button
            document.getElementById('startGameContainer').style.display = 'none';
            
            // Start the game
            startGame();
        }

        // Add global variables for best memory tracking
        let bestMemoryLevel = 0;
        let bestMemoryName = "None yet";
        let bestMemoryPic = "https://i.pravatar.cc/150?img=0";
        
        // Load best memory from localStorage
        function loadBestMemory() {
            const savedLevel = localStorage.getItem('bestMemoryLevel');
            if (savedLevel) {
                bestMemoryLevel = parseInt(savedLevel);
                bestMemoryName = localStorage.getItem('bestMemoryName') || "Unknown";
                bestMemoryPic = localStorage.getItem('bestMemoryPic') || "https://i.pravatar.cc/150?img=0";
                
                // Update the display
                document.getElementById('bestMemoryLevel').textContent = bestMemoryLevel;
                document.getElementById('bestMemoryName').textContent = bestMemoryName;
                document.getElementById('bestMemoryPic').src = bestMemoryPic;
            }
        }
        
        // Save best memory to localStorage
        function saveBestMemory() {
            localStorage.setItem('bestMemoryLevel', bestMemoryLevel);
            localStorage.setItem('bestMemoryName', bestMemoryName);
            localStorage.setItem('bestMemoryPic', bestMemoryPic);
        }
        
        // Clear best memory record
        function clearBestMemory() {
            bestMemoryLevel = 0;
            bestMemoryName = "None yet";
            bestMemoryPic = "https://i.pravatar.cc/150?img=0";
            
            // Update the display
            document.getElementById('bestMemoryLevel').textContent = bestMemoryLevel;
            document.getElementById('bestMemoryName').textContent = bestMemoryName;
            document.getElementById('bestMemoryPic').src = bestMemoryPic;
            
            // Clear from localStorage
            localStorage.removeItem('bestMemoryLevel');
            localStorage.removeItem('bestMemoryName');
            localStorage.removeItem('bestMemoryPic');
        }
    </script>

    <!-- Start Game Button (no overlay) -->
    <div class="start-game-container" id="startGameContainer">
        <button class="start-game-button" id="startGameButton">
            <span class="strobing-text">START GAME</span>
        </button>
    </div>
</body>
</html>
